services:
  hbase-compat-1:
    image: fluss-cape:1.0.0
    container_name: hbase-compat-1
    # Use bridge network instead of host for better isolation
    ports:
      - "16020:16020" # HBase RPC
      - "6379:6379"   # Redis
      - "5432:5432"   # PostgreSQL
      - "9092:9092"   # Kafka
      - "8081:8081"   # Health check
    environment:
      - FLUSS_BOOTSTRAP=host.docker.internal:35739 # Connect to host Fluss
      - ZK_QUORUM=host.docker.internal:2181
      - BIND_ADDRESS=0.0.0.0
      - BIND_PORT=16020
      - HEALTH_PORT=8081
      - SERVER_ID=server-1
      - TABLES=default.test_table,default.usertable
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  hbase-compat-2:
    image: fluss-cape:1.0.0
    container_name: hbase-compat-2
    ports:
      - "16021:16021"
      - "6380:6379"
      - "5433:5432"
      - "9093:9092"
      - "8082:8081"
    environment:
      - FLUSS_BOOTSTRAP=host.docker.internal:35739
      - ZK_QUORUM=host.docker.internal:2181
      - BIND_ADDRESS=0.0.0.0
      - BIND_PORT=16021
      - REDIS_BIND_PORT=6379
      - PG_PORT=5432
      - KAFKA_BIND_PORT=9092
      - HEALTH_PORT=8081
      - SERVER_ID=server-2
      - TABLES=default.test_table,default.usertable
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  hbase-compat-3:
    image: fluss-cape:1.0.0
    container_name: hbase-compat-3
    ports:
      - "16022:16022"
      - "6381:6379"
      - "5434:5432"
      - "9094:9092"
      - "8083:8081"
    environment:
      - FLUSS_BOOTSTRAP=host.docker.internal:35739
      - ZK_QUORUM=host.docker.internal:2181
      - BIND_ADDRESS=0.0.0.0
      - BIND_PORT=16022
      - REDIS_BIND_PORT=6379
      - PG_PORT=5432
      - KAFKA_BIND_PORT=9092
      - HEALTH_PORT=8081
      - SERVER_ID=server-3
      - TABLES=default.test_table,default.usertable
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
