/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.fluss.hbase.server;

import org.apache.fluss.client.Connection;
import org.apache.fluss.client.ConnectionFactory;
import org.apache.fluss.client.admin.Admin;
import org.apache.fluss.client.table.Table;
import org.apache.fluss.config.Configuration;
import org.apache.fluss.hbase.executor.GetExecutor;
import org.apache.fluss.hbase.executor.HBaseRequestRouter;
import org.apache.fluss.hbase.executor.MultiExecutor;
import org.apache.fluss.hbase.executor.PutExecutor;
import org.apache.fluss.hbase.executor.ScanExecutor;
import org.apache.fluss.hbase.mapping.CellConverter;
import org.apache.fluss.hbase.mapping.RowKeyEncoder;
import org.apache.fluss.hbase.metadata.MetaTableEmulator;
import org.apache.fluss.hbase.metadata.VirtualRegionManager;
import org.apache.fluss.metadata.TableInfo;
import org.apache.fluss.metadata.TablePath;
import org.apache.fluss.types.RowType;

import org.apache.hadoop.hbase.ServerName;
import org.apache.hadoop.hbase.TableName;
import org.apache.hadoop.hbase.util.Bytes;
import org.apache.hadoop.hbase.shaded.protobuf.generated.ZooKeeperProtos;
import org.apache.hadoop.hbase.shaded.protobuf.generated.HBaseProtos;
import org.apache.hbase.thirdparty.com.google.protobuf.ByteString;
import org.apache.zookeeper.CreateMode;
import org.apache.zookeeper.KeeperException;
import org.apache.zookeeper.ZooDefs;
import org.apache.zookeeper.ZooKeeper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.net.InetAddress;
import java.util.List;
import java.util.concurrent.CountDownLatch;

/**
 * Main launcher for HBase Compatibility Server.
 *
 * <p>Usage: java -jar fluss-hbase-compat.jar \ -Dfluss.bootstrap.servers=localhost:9123 \
 * -Dhbase.compat.bind.address=localhost \ -Dhbase.compat.bind.port=16020 \
 * -Dhbase.compat.tables=db.table1,db.table2
 */
public class HBaseCompatServerLauncher {
    private static final Logger LOG = LoggerFactory.getLogger(HBaseCompatServerLauncher.class);

    private static ZooKeeper zooKeeper;
    private static String regionServerZnodePath;
    private static String metaRegionServerZnodePath;

    public static void main(String[] args) throws Exception {
        // Parse configuration from system properties
        String flussBootstrapServers =
                System.getProperty("fluss.bootstrap.servers", "localhost:9123");
        String bindAddress = System.getProperty("hbase.compat.bind.address", "0.0.0.0");
        int bindPort = Integer.parseInt(System.getProperty("hbase.compat.bind.port", "16020"));
        String tablesList = System.getProperty("hbase.compat.tables", "");
        String zkQuorum = System.getProperty("hbase.zookeeper.quorum", "localhost:2181");

        LOG.info("========================================");
        LOG.info("Starting HBase Compatibility Server");
        LOG.info("========================================");
        LOG.info("Fluss cluster: {}", flussBootstrapServers);
        LOG.info("Bind address: {}:{}", bindAddress, bindPort);
        LOG.info("ZooKeeper: {}", zkQuorum);
        LOG.info("Tables: {}", tablesList.isEmpty() ? "none (meta only)" : tablesList);
        LOG.info("========================================");

        // Create Fluss connection
        Configuration config = new Configuration();
        config.setString("bootstrap.servers", flussBootstrapServers);
        Connection flussConn = ConnectionFactory.createConnection(config);
        Admin admin = flussConn.getAdmin();

        // Setup virtual region manager
        VirtualRegionManager regionManager = new VirtualRegionManager(bindAddress, bindPort);

        // Create router and register executors
        HBaseRequestRouter router = new HBaseRequestRouter();

        // Register meta table emulator for hbase:meta requests
        router.registerExecutor("hbase:meta", new MetaTableEmulator(regionManager));
        LOG.info("Registered meta table emulator (hbase:meta)");

        // Register user tables if specified
        if (!tablesList.isEmpty()) {
            String[] tables = tablesList.split(",");
            for (String tablePathStr : tables) {
                tablePathStr = tablePathStr.trim();
                if (tablePathStr.isEmpty()) {
                    continue;
                }

                try {
                    TablePath tablePath = parseTablePath(tablePathStr);
                    registerTable(flussConn, admin, router, regionManager, tablePath, bindAddress);
                } catch (Exception e) {
                    LOG.error("Failed to register table: {}", tablePathStr, e);
                    throw e;
                }
            }
        } else {
            LOG.warn(
                    "No tables configured. Only hbase:meta will be available. "
                            + "Set -Dhbase.compat.tables=db.table1,db.table2 to expose Fluss tables.");
        }

        // Start server
        HBaseCompatServer server = new HBaseCompatServer(config, bindAddress, bindPort, router);
        server.start();

        int actualPort = server.getBoundPort();
        String hostname = InetAddress.getLocalHost().getHostName();
        ServerName serverName = ServerName.valueOf(hostname, actualPort, System.currentTimeMillis());
        
        try {
            registerInZooKeeper(zkQuorum, serverName);
            LOG.info("Successfully registered in ZooKeeper");
        } catch (Exception e) {
            LOG.error("Failed to register in ZooKeeper", e);
            server.close();
            flussConn.close();
            throw e;
        }

        LOG.info("========================================");
        LOG.info("HBase Compatibility Server started!");
        LOG.info("========================================");
        LOG.info("HBase clients can connect to: {}:{}", hostname, actualPort);
        LOG.info("Connection string: {}:{}", hostname, actualPort);
        LOG.info("========================================");

        // Setup shutdown hook
        CountDownLatch shutdownLatch = new CountDownLatch(1);
        Runtime.getRuntime()
                .addShutdownHook(
                        new Thread(
                                () -> {
                                    LOG.info("Received shutdown signal");
                                    try {
                                        unregisterFromZooKeeper();
                                        server.close();
                                        flussConn.close();
                                    } catch (Exception e) {
                                        LOG.error("Error during shutdown", e);
                                    }
                                    shutdownLatch.countDown();
                                }));

        // Keep running
        shutdownLatch.await();
        LOG.info("HBase Compatibility Server stopped");
    }

    private static TablePath parseTablePath(String tablePathStr) {
        String[] parts = tablePathStr.split("\\.");
        if (parts.length == 2) {
            return TablePath.of(parts[0], parts[1]);
        } else if (parts.length == 1) {
            // Use "default" database if not specified
            return TablePath.of("default", parts[0]);
        } else {
            throw new IllegalArgumentException(
                    "Invalid table path: "
                            + tablePathStr
                            + ". Expected format: database.table or table");
        }
    }

    private static void registerTable(
            Connection flussConn,
            Admin admin,
            HBaseRequestRouter router,
            VirtualRegionManager regionManager,
            TablePath tablePath,
            String serverName)
            throws Exception {

        LOG.info("Registering table: {}", tablePath);

        // Get table info from Fluss
        TableInfo tableInfo = admin.getTableInfo(tablePath).get();
        if (tableInfo == null) {
            throw new IllegalArgumentException("Table not found in Fluss: " + tablePath);
        }

        RowType rowType = tableInfo.getRowType();
        List<String> primaryKeys = tableInfo.getPrimaryKeys();

        // Create row key encoder
        RowKeyEncoder rowKeyEncoder = new RowKeyEncoder(rowType, primaryKeys);

        // Create cell converter with default column family mapping
        CellConverter cellConverter =
                new CellConverter(
                        rowType, CellConverter.ColumnFamilyMapping.createDefault(rowType, "cf"));

        // Get table instance
        Table table = flussConn.getTable(tablePath);

        // Register all executors for this table
        String tableName = tablePath.getTableName();

        router.registerExecutor(
                "Get-" + tableName,
                new GetExecutor(flussConn, tablePath, rowKeyEncoder, cellConverter));

        router.registerExecutor(
                "Mutate-" + tableName,
                new PutExecutor(flussConn, tablePath, rowType, rowKeyEncoder, cellConverter));

        router.registerExecutor(
                "Scan-" + tableName,
                new ScanExecutor(flussConn, tablePath, rowKeyEncoder, cellConverter));

        router.registerExecutor(
                "Multi-" + tableName,
                new MultiExecutor(flussConn, tablePath, rowType, rowKeyEncoder, cellConverter));

        // Register table with region manager
        int bucketCount = tableInfo.getNumBuckets();
        TableName hbaseTableName = TableName.valueOf(tablePath.getTableName());
        regionManager.registerTable(hbaseTableName, bucketCount);

        LOG.info(
                "Successfully registered table: {} (primaryKeys={}, buckets={})",
                tablePath,
                primaryKeys,
                bucketCount);
    }

    private static void registerInZooKeeper(String zkQuorum, ServerName serverName)
            throws Exception {
        LOG.info("Connecting to ZooKeeper: {}", zkQuorum);
        
        CountDownLatch connectedSignal = new CountDownLatch(1);
        zooKeeper =
                new ZooKeeper(
                        zkQuorum,
                        30000,
                        event -> {
                            if (event.getState() == org.apache.zookeeper.Watcher.Event.KeeperState.SyncConnected) {
                                connectedSignal.countDown();
                            }
                        });

        connectedSignal.await();
        LOG.info("Connected to ZooKeeper");

        ensureZNodeExists("/hbase");
        ensureZNodeExists("/hbase/rs");
        ensureZNodeExists("/hbase/meta-region-server");

        regionServerZnodePath = "/hbase/rs/" + serverName.getServerName();
        byte[] serverInfoBytes = Bytes.toBytes(serverName.getServerName());

        zooKeeper.create(
                regionServerZnodePath,
                serverInfoBytes,
                ZooDefs.Ids.OPEN_ACL_UNSAFE,
                CreateMode.EPHEMERAL);

        LOG.info("Registered region server in ZooKeeper: {}", regionServerZnodePath);

        metaRegionServerZnodePath = "/hbase/meta-region-server";
        byte[] metaServerBytes = buildMetaRegionServerProtobuf(serverName);
        
        try {
            zooKeeper.setData(metaRegionServerZnodePath, metaServerBytes, -1);
        } catch (KeeperException.NoNodeException e) {
            zooKeeper.create(
                    metaRegionServerZnodePath,
                    metaServerBytes,
                    ZooDefs.Ids.OPEN_ACL_UNSAFE,
                    CreateMode.PERSISTENT);
        }

        LOG.info("Registered as meta region server in ZooKeeper (protobuf format): {}", metaRegionServerZnodePath);
    }

    private static void ensureZNodeExists(String path) throws Exception {
        try {
            if (zooKeeper.exists(path, false) == null) {
                zooKeeper.create(path, new byte[0], ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
                LOG.info("Created ZNode: {}", path);
            }
        } catch (KeeperException.NodeExistsException e) {
        }
    }

    private static byte[] buildMetaRegionServerProtobuf(ServerName serverName) {
        HBaseProtos.RegionInfo metaRegionInfo = HBaseProtos.RegionInfo.newBuilder()
                .setRegionId(1)
                .setTableName(HBaseProtos.TableName.newBuilder()
                        .setNamespace(ByteString.copyFrom(Bytes.toBytes("hbase")))
                        .setQualifier(ByteString.copyFrom(Bytes.toBytes("meta")))
                        .build())
                .setStartKey(ByteString.EMPTY)
                .setEndKey(ByteString.EMPTY)
                .build();
        
        HBaseProtos.ServerName serverNameProto = HBaseProtos.ServerName.newBuilder()
                .setHostName(serverName.getHostname())
                .setPort(serverName.getPort())
                .setStartCode(serverName.getStartcode())
                .build();
        
        ZooKeeperProtos.MetaRegionServer metaRegionServer = ZooKeeperProtos.MetaRegionServer.newBuilder()
                .setServer(serverNameProto)
                .setRpcVersion(1)
                .build();
        
        return metaRegionServer.toByteArray();
    }

    private static void unregisterFromZooKeeper() {
        if (zooKeeper != null) {
            try {
                if (regionServerZnodePath != null) {
                    try {
                        zooKeeper.delete(regionServerZnodePath, -1);
                        LOG.info("Unregistered from ZooKeeper: {}", regionServerZnodePath);
                    } catch (Exception e) {
                        LOG.warn("Failed to delete region server znode", e);
                    }
                }

                zooKeeper.close();
                LOG.info("ZooKeeper connection closed");
            } catch (Exception e) {
                LOG.error("Error closing ZooKeeper connection", e);
            }
        }
    }
}
